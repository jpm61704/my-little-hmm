<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">HMM</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.State.Lazy</span><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Identity</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Foldable</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">F</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Number.CReal</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Ratio</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Traversable</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">type</span><span> </span><a name="Probability"><a href="HMM.html#Probability"><span class="hs-identifier">Probability</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CReal</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- * Hidden Markov Models</span><span>
</span><a name="line-20"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">-- | The definition of a hidden markov model</span><span>
</span><a name="line-23"></a><span class="hs-comment">--   s := data type of states</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   o := data type of observations</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   p := data type of probabilities</span><span>
</span><a name="line-26"></a><span class="hs-comment">--   t := a traversable functor to contain the states and observations</span><span>
</span><a name="line-27"></a><span class="hs-keyword">data</span><span> </span><a name="HMM"><a href="HMM.html#HMM"><span class="hs-identifier">HMM</span></a></a><span> </span><a name="local-6989586621679031382"><a href="#local-6989586621679031382"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679031383"><a href="#local-6989586621679031383"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679031384"><a href="#local-6989586621679031384"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621679031385"><a href="#local-6989586621679031385"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="HMM"><a href="HMM.html#HMM"><span class="hs-identifier">HMM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="states"><a href="HMM.html#states"><span class="hs-identifier">states</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031385"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679031382"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-28"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="observations"><a href="HMM.html#observations"><span class="hs-identifier">observations</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031385"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679031383"><span class="hs-identifier hs-type">o</span></a><span>
</span><a name="line-29"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="initialProbability"><a href="HMM.html#initialProbability"><span class="hs-identifier">initialProbability</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031382"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031384"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-30"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="stateTransitions"><a href="HMM.html#stateTransitions"><span class="hs-identifier">stateTransitions</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031382"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031382"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031384"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-31"></a><span>                       </span><span class="hs-special">,</span><span> </span><a name="observationProbability"><a href="HMM.html#observationProbability"><span class="hs-identifier">observationProbability</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031382"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031383"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031384"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-32"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-identifier">stateCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679037208"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679037209"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679037210"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679037211"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679037208"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-35"></a><a name="stateCount"><a href="HMM.html#stateCount"><span class="hs-identifier">stateCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">states</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-identifier">observationCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679035364"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679035365"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679035366"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679035367"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679035364"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-38"></a><a name="observationCount"><a href="HMM.html#observationCount"><span class="hs-identifier">observationCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">observations</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">data</span><span> </span><a name="StateInfo"><a href="HMM.html#StateInfo"><span class="hs-identifier">StateInfo</span></a></a><span> </span><a name="local-6989586621679031379"><a href="#local-6989586621679031379"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679031380"><a href="#local-6989586621679031380"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679031381"><a href="#local-6989586621679031381"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="StateInfo"><a href="HMM.html#StateInfo"><span class="hs-identifier">StateInfo</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="pi_s"><a href="HMM.html#pi_s"><span class="hs-identifier">pi_s</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031381"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-41"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="p_inbound"><a href="HMM.html#p_inbound"><span class="hs-identifier">p_inbound</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031379"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031381"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-42"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="p_outbound"><a href="HMM.html#p_outbound"><span class="hs-identifier">p_outbound</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031379"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031381"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-43"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="p_obs"><a href="HMM.html#p_obs"><span class="hs-identifier">p_obs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031380"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031381"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-44"></a><span>                                 </span><span class="hs-special">}</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-identifier">stateInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679035360"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679035361"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679035362"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679035363"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679035360"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-type">StateInfo</span></a><span> </span><a href="#local-6989586621679035360"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679035361"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679035362"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-47"></a><a name="stateInfo"><a href="HMM.html#stateInfo"><span class="hs-identifier">stateInfo</span></a></a><span> </span><a name="local-6989586621679037212"><a href="#local-6989586621679037212"><span class="hs-identifier">hmm</span></a></a><span> </span><a name="local-6989586621679037213"><a href="#local-6989586621679037213"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-var">StateInfo</span></a><span> </span><a href="#local-6989586621679037214"><span class="hs-identifier hs-var">pi</span></a><span> </span><a href="#local-6989586621679037215"><span class="hs-identifier hs-var">p_i</span></a><span> </span><a href="#local-6989586621679037216"><span class="hs-identifier hs-var">p_o</span></a><span> </span><a href="#local-6989586621679037217"><span class="hs-identifier hs-var">p_os</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679037214"><a href="#local-6989586621679037214"><span class="hs-identifier">pi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">initialProbability</span><span> </span><a href="#local-6989586621679037212"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679037213"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-49"></a><span>        </span><a name="local-6989586621679037215"><a href="#local-6989586621679037215"><span class="hs-identifier">p_i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">stateTransitions</span><span> </span><a href="#local-6989586621679037212"><span class="hs-identifier hs-var">hmm</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679037213"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-50"></a><span>        </span><a name="local-6989586621679037216"><a href="#local-6989586621679037216"><span class="hs-identifier">p_o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">stateTransitions</span><span> </span><a href="#local-6989586621679037212"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679037213"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-51"></a><span>        </span><a name="local-6989586621679037217"><a href="#local-6989586621679037217"><span class="hs-identifier">p_os</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">observationProbability</span><span> </span><a href="#local-6989586621679037212"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679037213"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-identifier">overStateSpace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679031473"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679031474"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679031474"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679031475"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679031476"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679031473"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031474"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031477"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><a href="#local-6989586621679031474"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679031477"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-56"></a><a name="overStateSpace"><a href="HMM.html#overStateSpace"><span class="hs-identifier">overStateSpace</span></a></a><span> </span><a name="local-6989586621679037218"><a href="#local-6989586621679037218"><span class="hs-identifier">hmm</span></a></a><span> </span><a name="local-6989586621679037219"><a href="#local-6989586621679037219"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679037220"><a href="#local-6989586621679037220"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679037221"><a href="#local-6989586621679037221"><span class="hs-identifier">mm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">M.insert</span><span> </span><a href="#local-6989586621679037220"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679037219"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679037220"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679037221"><span class="hs-identifier hs-var">mm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M.empty</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">states</span><span> </span><a href="#local-6989586621679037218"><span class="hs-identifier hs-var">hmm</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">data</span><span> </span><a name="ObservationSeq"><a href="HMM.html#ObservationSeq"><span class="hs-identifier">ObservationSeq</span></a></a><span> </span><a name="local-6989586621679031377"><a href="#local-6989586621679031377"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679031378"><a href="#local-6989586621679031378"><span class="hs-identifier">seq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ObsSeq"><a href="HMM.html#ObsSeq"><span class="hs-identifier">ObsSeq</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="first"><a href="HMM.html#first"><span class="hs-identifier">first</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031377"><span class="hs-identifier hs-type">o</span></a><span>
</span><a name="line-59"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a name="rest"><a href="HMM.html#rest"><span class="hs-identifier">rest</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679031378"><span class="hs-identifier hs-type">seq</span></a><span> </span><a href="#local-6989586621679031377"><span class="hs-identifier hs-type">o</span></a><span>
</span><a name="line-60"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">fromList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679031472"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#ObservationSeq"><span class="hs-identifier hs-type">ObservationSeq</span></a><span> </span><a href="#local-6989586621679031472"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-63"></a><a name="fromList"><a href="HMM.html#fromList"><span class="hs-identifier">fromList</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679037222"><a href="#local-6989586621679037222"><span class="hs-identifier">o</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679037223"><a href="#local-6989586621679037223"><span class="hs-identifier">os</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HMM.html#ObsSeq"><span class="hs-identifier hs-var">ObsSeq</span></a><span> </span><a href="#local-6989586621679037222"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621679037223"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-keyword">data</span><span> </span><a name="StateSeq"><a href="HMM.html#StateSeq"><span class="hs-identifier">StateSeq</span></a></a><span> </span><a name="local-6989586621679031375"><a href="#local-6989586621679031375"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679031376"><a href="#local-6989586621679031376"><span class="hs-identifier">seq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="StateSeq"><a href="HMM.html#StateSeq"><span class="hs-identifier">StateSeq</span></a></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031376"><span class="hs-identifier hs-type">seq</span></a><span> </span><a href="#local-6989586621679031375"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- | a function applied to the probabilities of transition(a_ij * alpha_i) from s_i to s_j</span><span>
</span><a name="line-69"></a><span class="hs-identifier">pIntoG</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-type">StateInfo</span></a><span> </span><a href="#local-6989586621679031470"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679031471"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><a href="#local-6989586621679031470"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031469"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-70"></a><a name="pIntoG"><a href="HMM.html#pIntoG"><span class="hs-identifier">pIntoG</span></a></a><span> </span><a name="local-6989586621679037224"><a href="#local-6989586621679037224"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679037225"><a href="#local-6989586621679037225"><span class="hs-identifier">st_info</span></a></a><span> </span><a name="local-6989586621679037226"><a href="#local-6989586621679037226"><span class="hs-identifier">a_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.foldrWithKey</span><span> </span><a href="#local-6989586621679037227"><span class="hs-identifier hs-var">sumIncomingProbability</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679037226"><span class="hs-identifier hs-var">a_map</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679037227"><a href="#local-6989586621679037227"><span class="hs-identifier">sumIncomingProbability</span></a></a><span> </span><a name="local-6989586621679037228"><a href="#local-6989586621679037228"><span class="hs-identifier">s_i</span></a></a><span> </span><a name="local-6989586621679037229"><a href="#local-6989586621679037229"><span class="hs-identifier">alpha_i</span></a></a><span> </span><a name="local-6989586621679037230"><a href="#local-6989586621679037230"><span class="hs-identifier">sum</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679037231"><a href="#local-6989586621679037231"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">p_inbound</span><span> </span><a href="#local-6989586621679037225"><span class="hs-identifier hs-var">st_info</span></a><span> </span><a href="#local-6989586621679037228"><span class="hs-identifier hs-var">s_i</span></a><span>
</span><a name="line-72"></a><span>                                                 </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679037224"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679037230"><span class="hs-identifier hs-var">sum</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679037231"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679037229"><span class="hs-identifier hs-var">alpha_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">accumMultiply</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-type">StateInfo</span></a><span> </span><a href="#local-6989586621679031387"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679031388"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031387"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679031386"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-78"></a><a name="accumMultiply"><a href="HMM.html#accumMultiply"><span class="hs-identifier">accumMultiply</span></a></a><span> </span><a name="local-6989586621679037232"><a href="#local-6989586621679037232"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679037233"><a href="#local-6989586621679037233"><span class="hs-identifier">st_info</span></a></a><span> </span><a name="local-6989586621679037234"><a href="#local-6989586621679037234"><span class="hs-identifier">s_i</span></a></a><span> </span><a name="local-6989586621679037235"><a href="#local-6989586621679037235"><span class="hs-identifier">alpha_i</span></a></a><span> </span><a name="local-6989586621679037236"><a href="#local-6989586621679037236"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679037232"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679037236"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679037237"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679037235"><span class="hs-identifier hs-var">alpha_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679037237"><a href="#local-6989586621679037237"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">p_inbound</span><span> </span><a href="#local-6989586621679037233"><span class="hs-identifier hs-var">st_info</span></a><span> </span><a href="#local-6989586621679037234"><span class="hs-identifier hs-var">s_i</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- ** Helper functions for Monads</span><span>
</span><a name="line-83"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-comment">-- *** HMMComp - Stateful actions within an HMM environment(reader)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- type HMMComp s o p t env m = StateT env (ReaderT (HMM s o p t) m)</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- overStateSpace :: (Monad m, Ord s, Traversable t)</span><span>
</span><a name="line-90"></a><span class="hs-comment">--                =&gt; (s -&gt; HMMComp s o p t st m a)</span><span>
</span><a name="line-91"></a><span class="hs-comment">--                -&gt; HMMComp s o p t st m (M.Map s a)</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- overStateSpace f = do</span><span>
</span><a name="line-93"></a><span class="hs-comment">--   sts &lt;- lift $ getStates</span><span>
</span><a name="line-94"></a><span class="hs-comment">--   foldl (\mm x -&gt; do</span><span>
</span><a name="line-95"></a><span class="hs-comment">--             m &lt;- mm</span><span>
</span><a name="line-96"></a><span class="hs-comment">--             y &lt;- f x</span><span>
</span><a name="line-97"></a><span class="hs-comment">--             return $ M.insert x y m</span><span>
</span><a name="line-98"></a><span class="hs-comment">--          ) (return M.empty) sts</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- -- *** ReaderT functions</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- getStates :: (Monad m) =&gt; ReaderT (HMM s o p t) m (t s)</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- getStates = reader states</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- foreachState :: (Traversable t, Monad m)</span><span>
</span><a name="line-106"></a><span class="hs-comment">--              =&gt; (a -&gt; ReaderT (HMM a o p t) m b)</span><span>
</span><a name="line-107"></a><span class="hs-comment">--              -&gt; ReaderT (HMM a o p t) m (t b)</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- foreachState f = do</span><span>
</span><a name="line-109"></a><span class="hs-comment">--   sts &lt;- getStates</span><span>
</span><a name="line-110"></a><span class="hs-comment">--   forM sts f</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">-- foreachStateMap :: (Ord a, Traversable t, Monad m)</span><span>
</span><a name="line-113"></a><span class="hs-comment">--                 =&gt; (a -&gt; ReaderT (HMM a o p t) m b)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--                 -&gt; ReaderT (HMM a o p t) m (M.Map a b)</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- foreachStateMap f = do</span><span>
</span><a name="line-116"></a><span class="hs-comment">--   sts &lt;- getStates</span><span>
</span><a name="line-117"></a><span class="hs-comment">--   foldl (\mm x -&gt; do</span><span>
</span><a name="line-118"></a><span class="hs-comment">--             m &lt;- mm</span><span>
</span><a name="line-119"></a><span class="hs-comment">--             y &lt;- f x</span><span>
</span><a name="line-120"></a><span class="hs-comment">--             return $ M.insert x y m</span><span>
</span><a name="line-121"></a><span class="hs-comment">--         ) (return M.empty) sts</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- getInitialProbability :: (Monad m) =&gt; s -&gt; ReaderT (HMM s o p t) m p</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- getInitialProbability s = reader initialProbability &gt;&gt;= \f -&gt; return $ f s</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- getObsProbability :: (Monad m) =&gt; s -&gt; o -&gt; ReaderT (HMM s o p t) m p</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- getObsProbability s o = reader observationProbability &gt;&gt;= \f -&gt; return $ f s o</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">-- getStateTransPs :: (Monad m) =&gt; s -&gt; s -&gt; ReaderT (HMM s o p t) m p</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- getStateTransPs si sj = reader stateTransitions &gt;&gt;= \f -&gt; return $ f si sj</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">-- getStateInfo :: (Monad m) =&gt; s -&gt; ReaderT (HMM s o p t) m (StateInfo s o p)</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- getStateInfo st = reader $ flip stateInfo st</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">-- NOTES</span><span>
</span><a name="line-137"></a><span class="hs-comment">{-
========================================
Creating an HMM Computation Monad Stack
========================================

I want to create a Monad stack that:

a.) is safe and doesn't allow for bogus computations
b.) allows for the following variables to be calculated somewhat easily:
    - alpha_t(i) = P(O_1 ... O_t, q_t = S_i | lambda)
    - beta_t(i)  = P(O_(t+1) ... O_T | q_t = S_i, lambda)
    - gamma_t(i) = P(q_t = S_i | OSeq, lambda)


We have some parts of the computation
a.) information from without(input variables)
    - these data can be present at different &quot;levels&quot; of the environment
      example: the hmm configuration has a higher order than state and observation
               information
b.) contributing calculations from within(memoized or cps data)
-}</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- * Towards a more declarative algorithm</span><span>
</span><a name="line-162"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-163"></a><span class="hs-comment">{-
While working the above problems out, it came to me that it would make sense to wrap
all of these algorithms in a WriterT StateT Monad stack so that constants, such as the
HMM parameters, and variables, such as alpha, beta, etc, can be seperated but still
accessed in a convenient way.

The downside to this approach is that this essentially creates an imperative sandbox
inside of our functional space. The better approach would be to create a declarative
space to built out these problems. The issue with this is mostly that many of the
values present in these algorithms depend(in a recursive manner) on values before them.

This trait is well suited to be solved in a monadic space as mentioned above, but it
is less than desirable to remain consistent with my usual design methodology.

The likely solution to this problem is creating more data types in order to abstract
the problem so that it doesn't call for the use of side effects in the way prescribed
in the current solution for step 1.

For instance we could create a data type called Node that captures the notion of a
single observation or state in an observation sequence. One possibility is that a
fold exists where a Node starts off in some super-state and is collapsed into a solution
value. This idea is what I think is really trying to be captured in the algorithms that
deal with HMMs.

The example in the tutorial paper has a bunch of diagrams that are nodes being connected
to every node in the next, previous, or both directions with respect to time. This appears
to be at least a slightly more declarative version of the algorithms presented in the
normal mathematical notation.
-}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a></pre></body></html>