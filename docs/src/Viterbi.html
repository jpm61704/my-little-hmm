<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Viterbi</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><a href="HMM.html"><span class="hs-identifier">HMM</span></a><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><a href="ForwardAlgorithm.html"><span class="hs-identifier">ForwardAlgorithm</span></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Sequence</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Foldable</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-- * Decoding (Problem 2)</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-identifier">decode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679053126"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679053126"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053128"><span class="hs-identifier hs-type">seq</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053129"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679053129"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053130"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679053126"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#ObservationSeq"><span class="hs-identifier hs-type">ObservationSeq</span></a><span> </span><a href="#local-6989586621679053130"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053128"><span class="hs-identifier hs-type">seq</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053129"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-14"></a><a name="decode"><a href="Viterbi.html#decode"><span class="hs-identifier">decode</span></a></a><span> </span><a name="local-6989586621679053131"><a href="#local-6989586621679053131"><span class="hs-identifier">hmm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maximum</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Viterbi.html#viterbis_T"><span class="hs-identifier hs-var">viterbis_T</span></a><span> </span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">hmm</span></a><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-comment">-- ** Viterbi Variable</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">-- | The viterbi variable aggregate which includes the probability</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- and (most likely) previous state for backtracing</span><span>
</span><a name="line-20"></a><span class="hs-keyword">data</span><span> </span><a name="V"><a href="Viterbi.html#V"><span class="hs-identifier">V</span></a></a><span> </span><a name="local-6989586621679053094"><a href="#local-6989586621679053094"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679053095"><a href="#local-6989586621679053095"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="V"><a href="Viterbi.html#V"><span class="hs-identifier">V</span></a></a><span> </span><a href="#local-6989586621679053094"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053095"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-21"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Vi"><a href="Viterbi.html#Vi"><span class="hs-identifier">Vi</span></a></a><span> </span><a href="#local-6989586621679053095"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-22"></a><span>           </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053096"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679053097"><a href="#local-6989586621679053097"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><a name="local-6989586621679053098"><a href="#local-6989586621679053098"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679053099"><a href="#local-6989586621679053099"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><a href="#local-6989586621679053098"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679053097"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679053099"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-identifier">vNil</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053124"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053125"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053124"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-28"></a><a name="vNil"><a href="Viterbi.html#vNil"><span class="hs-identifier">vNil</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-identifier">probv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053122"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053123"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053123"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-31"></a><a name="probv"><a href="Viterbi.html#probv"><span class="hs-identifier">probv</span></a></a><span> </span><span class="hs-special">(</span><a href="Viterbi.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><a name="local-6989586621679053132"><a href="#local-6989586621679053132"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679053132"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-32"></a><a name="probV"><a href="Viterbi.html#probV"><span class="hs-identifier">probV</span></a></a><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679053133"><a href="#local-6989586621679053133"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679053133"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">type</span><span> </span><a name="ViterbiMap"><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier">ViterbiMap</span></a></a><span> </span><a name="local-6989586621679053092"><a href="#local-6989586621679053092"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679053093"><a href="#local-6989586621679053093"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><a href="#local-6989586621679053092"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053092"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053093"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-identifier">viterbis_T</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053117"><span class="hs-identifier hs-type">seq</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053118"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053118"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053119"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053120"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679053120"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053121"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053118"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679053119"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-38"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#ObservationSeq"><span class="hs-identifier hs-type">ObservationSeq</span></a><span> </span><a href="#local-6989586621679053121"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053117"><span class="hs-identifier hs-type">seq</span></a><span>
</span><a name="line-39"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier hs-type">ViterbiMap</span></a><span> </span><a href="#local-6989586621679053120"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053118"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-40"></a><a name="viterbis_T"><a href="Viterbi.html#viterbis_T"><span class="hs-identifier">viterbis_T</span></a></a><span> </span><a name="local-6989586621679053134"><a href="#local-6989586621679053134"><span class="hs-identifier">hmm</span></a></a><span> </span><span class="hs-special">(</span><a href="HMM.html#ObsSeq"><span class="hs-identifier hs-var">ObsSeq</span></a><span> </span><a name="local-6989586621679053135"><a href="#local-6989586621679053135"><span class="hs-identifier">fst</span></a></a><span> </span><a name="local-6989586621679053136"><a href="#local-6989586621679053136"><span class="hs-identifier">rst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="#local-6989586621679053137"><span class="hs-identifier hs-var">v_t</span></a><span> </span><a href="#local-6989586621679053138"><span class="hs-identifier hs-var">v_1</span></a><span> </span><a href="#local-6989586621679053136"><span class="hs-identifier hs-var">rst</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679053137"><a href="#local-6989586621679053137"><span class="hs-identifier">v_t</span></a></a><span> </span><a name="local-6989586621679053139"><a href="#local-6989586621679053139"><span class="hs-identifier">vm</span></a></a><span> </span><a name="local-6989586621679053140"><a href="#local-6989586621679053140"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#viterbis_t"><span class="hs-identifier hs-var">viterbis_t</span></a><span> </span><a href="#local-6989586621679053139"><span class="hs-identifier hs-var">vm</span></a><span> </span><a href="#local-6989586621679053134"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679053140"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-42"></a><span>        </span><a name="local-6989586621679053138"><a href="#local-6989586621679053138"><span class="hs-identifier">v_1</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#viterbis_1"><span class="hs-identifier hs-var">viterbis_1</span></a><span> </span><a href="#local-6989586621679053134"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679053135"><span class="hs-identifier hs-var">fst</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- | viterbi variable for the first observation(O_1) in a sequence</span><span>
</span><a name="line-45"></a><span class="hs-identifier">viterbis_1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053113"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053115"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053116"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053113"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679053115"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053116"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier hs-type">ViterbiMap</span></a><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053113"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-46"></a><a name="viterbis_1"><a href="Viterbi.html#viterbis_1"><span class="hs-identifier">viterbis_1</span></a></a><span> </span><a name="local-6989586621679053141"><a href="#local-6989586621679053141"><span class="hs-identifier">hmm</span></a></a><span> </span><a name="local-6989586621679053142"><a href="#local-6989586621679053142"><span class="hs-identifier">obs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Viterbi.html#Vi"><span class="hs-identifier hs-var">Vi</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ForwardAlgorithm.html#alphas%27"><span class="hs-identifier hs-var">alphas'</span></a><span> </span><span class="hs-special">(</span><a href="ForwardAlgorithm.html#alpha1"><span class="hs-identifier hs-var">alpha1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679053141"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679053142"><span class="hs-identifier hs-var">obs</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-identifier">viterbis_t</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053110"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier hs-type">ViterbiMap</span></a><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#HMM"><span class="hs-identifier hs-type">HMM</span></a><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053112"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-6989586621679053110"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053112"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier hs-type">ViterbiMap</span></a><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-49"></a><a name="viterbis_t"><a href="Viterbi.html#viterbis_t"><span class="hs-identifier">viterbis_t</span></a></a><span> </span><a name="local-6989586621679053143"><a href="#local-6989586621679053143"><span class="hs-identifier">vmap</span></a></a><span> </span><a name="local-6989586621679053144"><a href="#local-6989586621679053144"><span class="hs-identifier">hmm</span></a></a><span> </span><a name="local-6989586621679053145"><a href="#local-6989586621679053145"><span class="hs-identifier">obs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HMM.html#overStateSpace"><span class="hs-identifier hs-var">overStateSpace</span></a><span> </span><a href="#local-6989586621679053144"><span class="hs-identifier hs-var">hmm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679053146"><a href="#local-6989586621679053146"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#viterbi_t"><span class="hs-identifier hs-var">viterbi_t</span></a><span> </span><a href="#local-6989586621679053143"><span class="hs-identifier hs-var">vmap</span></a><span> </span><span class="hs-special">(</span><a href="HMM.html#stateInfo"><span class="hs-identifier hs-var">stateInfo</span></a><span> </span><a href="#local-6989586621679053144"><span class="hs-identifier hs-var">hmm</span></a><span> </span><a href="#local-6989586621679053146"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679053145"><span class="hs-identifier hs-var">obs</span></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">viterbi_t</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Viterbi.html#ViterbiMap"><span class="hs-identifier hs-type">ViterbiMap</span></a><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-type">StateInfo</span></a><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053108"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053108"><span class="hs-identifier hs-type">o</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-52"></a><a name="viterbi_t"><a href="Viterbi.html#viterbi_t"><span class="hs-identifier">viterbi_t</span></a></a><span> </span><a name="local-6989586621679053147"><a href="#local-6989586621679053147"><span class="hs-identifier">vmap</span></a></a><span> </span><a name="local-6989586621679053148"><a href="#local-6989586621679053148"><span class="hs-identifier">stinfo_j</span></a></a><span> </span><a name="local-6989586621679053149"><a href="#local-6989586621679053149"><span class="hs-identifier">obs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679053150"><span class="hs-identifier hs-var">b_j</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679053151"><span class="hs-identifier hs-var">p_into</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679053150"><a href="#local-6989586621679053150"><span class="hs-identifier">b_j</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">p_obs</span><span> </span><a href="#local-6989586621679053148"><span class="hs-identifier hs-var">stinfo_j</span></a><span> </span><a href="#local-6989586621679053149"><span class="hs-identifier hs-var">obs</span></a><span>
</span><a name="line-54"></a><span>        </span><a name="local-6989586621679053151"><a href="#local-6989586621679053151"><span class="hs-identifier">p_into</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#pIntoV"><span class="hs-identifier hs-var">pIntoV</span></a><span> </span><a href="#local-6989586621679053148"><span class="hs-identifier hs-var">stinfo_j</span></a><span> </span><a href="#local-6989586621679053147"><span class="hs-identifier hs-var">vmap</span></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">-- * Utility Functions</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- | calculations the maximal value and its argument when a function f is applied to</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- a foldable functor</span><span>
</span><a name="line-61"></a><span class="hs-identifier">argmax</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053103"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679053104"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679053104"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679053105"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053103"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679053104"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679053105"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679053103"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053105"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><a name="argmax"><a href="Viterbi.html#argmax"><span class="hs-identifier">argmax</span></a></a><span> </span><a name="local-6989586621679053152"><a href="#local-6989586621679053152"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679053153"><a href="#local-6989586621679053153"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maximumBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679053154"><a href="#local-6989586621679053154"><span class="hs-identifier">fx</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679053155"><a href="#local-6989586621679053155"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679053156"><a href="#local-6989586621679053156"><span class="hs-identifier">fy</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679053157"><a href="#local-6989586621679053157"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">fx</span></a><span> </span><a href="#local-6989586621679053156"><span class="hs-identifier hs-var">fy</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">fx</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">LT</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679053158"><a href="#local-6989586621679053158"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679053152"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679053158"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053158"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679053153"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-identifier">pIntoV</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="HMM.html#StateInfo"><span class="hs-identifier hs-type">StateInfo</span></a><span> </span><a href="#local-6989586621679053101"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053102"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><a href="#local-6989586621679053101"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053101"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-type">V</span></a><span> </span><a href="#local-6989586621679053101"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-65"></a><a name="pIntoV"><a href="Viterbi.html#pIntoV"><span class="hs-identifier">pIntoV</span></a></a><span> </span><a name="local-6989586621679053159"><a href="#local-6989586621679053159"><span class="hs-identifier">st_info</span></a></a><span> </span><a name="local-6989586621679053160"><a href="#local-6989586621679053160"><span class="hs-identifier">v_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.foldrWithKey</span><span> </span><a href="#local-6989586621679053161"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="Viterbi.html#vNil"><span class="hs-identifier hs-var">vNil</span></a><span> </span><a href="#local-6989586621679053160"><span class="hs-identifier hs-var">v_map</span></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679053161"><a href="#local-6989586621679053161"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679053162"><a href="#local-6989586621679053162"><span class="hs-identifier">s_i</span></a></a><span> </span><a name="local-6989586621679053163"><a href="#local-6989586621679053163"><span class="hs-identifier">v_i</span></a></a><span> </span><a name="local-6989586621679053164"><a href="#local-6989586621679053164"><span class="hs-identifier">max</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Viterbi.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><a name="local-6989586621679053165"><a href="#local-6989586621679053165"><span class="hs-identifier">s_max</span></a></a><span> </span><a name="local-6989586621679053166"><a href="#local-6989586621679053166"><span class="hs-identifier">v_max</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053167"><a href="#local-6989586621679053167"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">p_inbound</span><span> </span><a href="#local-6989586621679053159"><span class="hs-identifier hs-var">st_info</span></a><span> </span><a href="#local-6989586621679053162"><span class="hs-identifier hs-var">s_i</span></a><span>
</span><a name="line-67"></a><span>                                            </span><a name="local-6989586621679053168"><a href="#local-6989586621679053168"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679053167"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><a href="Viterbi.html#probv"><span class="hs-identifier hs-var">probv</span></a><span> </span><a href="#local-6989586621679053163"><span class="hs-identifier hs-var">v_i</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>                                            </span><a name="local-6989586621679053169"><a href="#local-6989586621679053169"><span class="hs-identifier">max'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Viterbi.html#V"><span class="hs-identifier hs-var">V</span></a><span> </span><a href="#local-6989586621679053162"><span class="hs-identifier hs-var">s_i</span></a><span> </span><a href="#local-6989586621679053168"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-69"></a><span>                                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679053166"><span class="hs-identifier hs-var">v_max</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679053168"><span class="hs-identifier hs-var">v'</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679053164"><span class="hs-identifier hs-var">max</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679053169"><span class="hs-identifier hs-var">max'</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- pIntoG'' :: (Num p) =&gt; (p -&gt; p -&gt; a) -&gt; StateInfo s o p -&gt; M.Map s a -&gt; a</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- pIntoG'' f st_info a_map = M.foldrWithKey sumIncomingProbability 0 a_map</span><span>
</span><a name="line-75"></a><span class="hs-comment">--   where sumIncomingProbability s_i alpha_i sum = let a = p_inbound st_info s_i</span><span>
</span><a name="line-76"></a><span class="hs-comment">--                                                  in f sum (a * alpha_i)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- selector :: (p -&gt; p -&gt; Ordering) -&gt; s -&gt; s -&gt; p -&gt; p -&gt; (p,s)</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- selector f s_1 s_2 p_1 p_2 = case f p_1 p_2 of</span><span>
</span><a name="line-80"></a><span class="hs-comment">--                                GT -&gt; (p_1, s_1)</span><span>
</span><a name="line-81"></a><span class="hs-comment">--                                otherwise -&gt; (p_2, s_2)</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- * Viterbi Algorithm: Finding the most likely state sequence given an observation sequence (Problem 2)</span><span>
</span><a name="line-85"></a><span class="hs-comment">-------------------------------------------------------------------------------------</span><span>
</span><a name="line-86"></a><span class="hs-comment">{-
The only main difference between this algorithm and the one above is keeping track
of the psi-values for each state along the sequence and the use of max instead of
the sum. This should also help us generalize the above so that code reuse can be
maximized.

The most efficient data structure to keep track of the psi-values should be a regular
hash map.

-}</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- data ViterbiVariable p s = VV { delta :: p</span><span>
</span><a name="line-98"></a><span class="hs-comment">--                               , phi   :: s</span><span>
</span><a name="line-99"></a><span class="hs-comment">--                               } deriving (Eq)</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- instance (Ord p, Eq s) =&gt; Ord (ViterbiVariable p s) where</span><span>
</span><a name="line-102"></a><span class="hs-comment">--   a &lt;= b = (delta a) &lt;= (delta b)</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">-- nextViterbiVariable :: (Monad m, Traversable t, Functor t, Foldable t, Num p, Ord p, Ord s)</span><span>
</span><a name="line-105"></a><span class="hs-comment">--                      =&gt; (s -&gt; p)</span><span>
</span><a name="line-106"></a><span class="hs-comment">--                      -&gt; o</span><span>
</span><a name="line-107"></a><span class="hs-comment">--                      -&gt; s</span><span>
</span><a name="line-108"></a><span class="hs-comment">--                      -&gt; ReaderT (HMM s o p t) m (ViterbiVariable p s)</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- nextViterbiVariable v_i obs s_j = do</span><span>
</span><a name="line-110"></a><span class="hs-comment">--   b_j &lt;- getObsProbability s_j obs</span><span>
</span><a name="line-111"></a><span class="hs-comment">--   (phi, amax) &lt;- liftM argmax $ foreachStateMap $ \s_i -&gt; do</span><span>
</span><a name="line-112"></a><span class="hs-comment">--     p_itoj &lt;- (getStateTransPs s_i s_j)</span><span>
</span><a name="line-113"></a><span class="hs-comment">--     return $ p_itoj * (v_i s_i)</span><span>
</span><a name="line-114"></a><span class="hs-comment">--   let delta = b_j * amax</span><span>
</span><a name="line-115"></a><span class="hs-comment">--   return $ VV delta phi</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">-- type ViterbiMap p s = M.Map s (ViterbiVariable p s)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- nextViterbiRow :: (Monad m, Traversable t, Num p, Ord p, Ord s)</span><span>
</span><a name="line-120"></a><span class="hs-comment">--                =&gt; (s -&gt; p)</span><span>
</span><a name="line-121"></a><span class="hs-comment">--                -&gt; o</span><span>
</span><a name="line-122"></a><span class="hs-comment">--                -&gt; ReaderT (HMM s o p t) m (ViterbiMap p s)</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- nextViterbiRow v_i obs = foreachStateMap (nextViterbiVariable v_i obs)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- viterbi :: (Num p, Ord p, Ord s, Traversable t, Show s)</span><span>
</span><a name="line-126"></a><span class="hs-comment">--         =&gt; HMM s o p t</span><span>
</span><a name="line-127"></a><span class="hs-comment">--         -&gt; ObservationSequence o</span><span>
</span><a name="line-128"></a><span class="hs-comment">--         -&gt; (p, StateSequence s)</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- viterbi hmm os = runReader (viterbiWReader os) hmm</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- viterbiWReader :: (Num p, Ord p, Ord s, Traversable t, Show s)</span><span>
</span><a name="line-132"></a><span class="hs-comment">--         =&gt; ObservationSequence o</span><span>
</span><a name="line-133"></a><span class="hs-comment">--         -&gt; Reader (HMM s o p t) (p, StateSequence s)</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- viterbiWReader os = do</span><span>
</span><a name="line-135"></a><span class="hs-comment">--   let getObsAt = getObservationAt os</span><span>
</span><a name="line-136"></a><span class="hs-comment">--   v_1 &lt;- initialViterbi $ getObsAt 0</span><span>
</span><a name="line-137"></a><span class="hs-comment">--   let initialMap = M.singleton 0 v_1</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">--   -- The next line is really gross and needs to be cleaned up</span><span>
</span><a name="line-140"></a><span class="hs-comment">--   -- TODO: The line below is what is breaking shit</span><span>
</span><a name="line-141"></a><span class="hs-comment">--   vs &lt;- F.foldlM (\m i -&gt; nextViterbiRow (\s -&gt; delta $ m &lt;!!&gt; (i,s)) (getObsAt i) &gt;&gt;= \x -&gt; return (M.insert i x m)) initialMap $ [1..((endOfSeq os) - 1)]</span><span>
</span><a name="line-142"></a><span class="hs-comment">--   viterbiTerminate vs</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- argmax :: (Ord v) =&gt; M.Map k v -&gt; (k, v)</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- argmax m = M.foldrWithKey (\k x mx@(k_m, v_m) -&gt; if x &gt; v_m then (k, x) else mx ) kv_1 m</span><span>
</span><a name="line-146"></a><span class="hs-comment">--   where kv_1 = M.elemAt 0 m</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-comment">-- initialViterbi :: (Monad m, Num p, Ord s, Traversable t) =&gt; o -&gt; ReaderT (HMM s o p t) m (ViterbiMap p s)</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- initialViterbi obs = foreachStateMap $ \s -&gt; do</span><span>
</span><a name="line-150"></a><span class="hs-comment">--   b &lt;- getObsProbability s obs</span><span>
</span><a name="line-151"></a><span class="hs-comment">--   y &lt;- getInitialProbability s</span><span>
</span><a name="line-152"></a><span class="hs-comment">--   return $ VV (b * y) undefined</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- type StateSequence s = M.Map Time s</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- viterbiTerminate :: (Monad m, Ord p, Ord s) =&gt; M.Map Time (ViterbiMap p s) -&gt; ReaderT (HMM s o p t) m (p, StateSequence s)</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- viterbiTerminate m = do</span><span>
</span><a name="line-158"></a><span class="hs-comment">--   let (t_max, t_map) = M.findMax m</span><span>
</span><a name="line-159"></a><span class="hs-comment">--       (q_T', vv) = argmax t_map</span><span>
</span><a name="line-160"></a><span class="hs-comment">--       (VV p' _) = vv</span><span>
</span><a name="line-161"></a><span class="hs-comment">--   -- next step is to finish up with backtracking</span><span>
</span><a name="line-162"></a><span class="hs-comment">--   return $ (p', backtrack q_T' m)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- backtrack :: (Ord s) =&gt; s -&gt; M.Map Time (ViterbiMap p s) -&gt; StateSequence s</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- backtrack q_T' m = M.foldlWithKey findNextState (M.empty) m</span><span>
</span><a name="line-166"></a><span class="hs-comment">--   where findNextState ss t vmap = M.insert t (phi $ vmap M.! (ss M.! t)) ss</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- lookup2 :: (Ord k1, Ord k2) =&gt; k1 -&gt; k2 -&gt; M.Map k1 (M.Map k2 a) -&gt; Maybe a</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- lookup2 k_outer k_inner m = do</span><span>
</span><a name="line-170"></a><span class="hs-comment">--   m' &lt;- M.lookup k_outer m</span><span>
</span><a name="line-171"></a><span class="hs-comment">--   M.lookup k_inner m'</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">-- (&lt;!!&gt;) :: (Ord k1, Ord k2, Show k1, Show k2) =&gt; M.Map k1 (M.Map k2 a) -&gt; (k1,k2) -&gt; a</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- (&lt;!!&gt;) m (ko, ki) = case lookup2 ko ki m of</span><span>
</span><a name="line-175"></a><span class="hs-comment">--                       Just x -&gt; x</span><span>
</span><a name="line-176"></a><span class="hs-comment">--                       Nothing -&gt; error $ (show ko) ++ &quot; -&gt; &quot; ++ (show ki) ++ &quot; did not map to a value&quot;</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a></pre></body></html>